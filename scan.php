<?php
ini_set('display_errors', 1);
error_reporting(E_ALL);
// Database configuration
$servername = "localhost";
$username = "sally";
$password = "Violets2_";
$dbname = "nmap_reports";

// Create a new database connection
$conn = new mysqli($servername, $username, $password, $dbname);

// Check the database connection
if ($conn->connect_error) {
    die("Connection failed: " . $conn->connect_error);
}

// Check if the 'target' parameter is set in the POST request
if (isset($_POST['target'])) {
    $target = $_POST['target'];
    $output = shell_exec("nmap --top-ports 20 -sC $target");

    // Store the scanning result in the database
    $sql = "INSERT INTO scan_results (target, result) VALUES ('$target', '$output')";
    if ($conn->query($sql) === TRUE) {
        //echo "Scan results stored successfully in the database.";
    } else {
        echo "Error: " . $sql . "<br>" . $conn->error;
    }
    

    // Generate report for the latest scan result
    $latestScanResult = getLatestScanResult();
    $report = generateReport($target, $latestScanResult);
    echo "<h3>Scan Report</h3>";
    echo "<pre>" . $report . "</pre>";

    // Logout button
    echo '<a href="login.php">Logout</a>';
}

// Close the database connection
$conn->close();

// Function to get the latest scan result
function getLatestScanResult() {
    global $conn;
    $sql = "SELECT result FROM scan_results ORDER BY scan_time DESC";
    $result = $conn->query($sql);

    if ($result->num_rows > 0) {
        $row = $result->fetch_assoc();
        return $row["result"];
    } else {
        return "Scan result not found.";
    }
}

// Function to generate a report based on a specific scan result
function generateReport($target, $result) {
    // Customize this function to format the report according to your requirements
    $openPorts = extractOpenPorts($result);
    $report = "Target: " . $target . "\n";
    $report .= "Result: " . $result . "\n";
    if (!empty($openPorts)) {
        $report .= "Open Ports:\n";
        foreach ($openPorts as $port) {
            $report .= "- " . $port . "\n";
        }
    } else {
        $report .= "No open ports found.\n";
    }
    $report .= "Report generated on: " . date('Y-m-d H:i:s') . "\n";

    return $report;
}

function extractOpenPorts($result) {
    $openPorts = array();

    // Regular expression pattern to match open ports
    $pattern = '/(\d+)\/(tcp|udp)\s+open/';

    // Perform the regular expression match
    preg_match_all($pattern, $result, $matches);

    // Extract the matched ports
    if (isset($matches[1]) && isset($matches[2])) {
        $portNumbers = $matches[1];
        $protocols = $matches[2];

        // Combine the port numbers and protocols
        for ($i = 0; $i < count($portNumbers); $i++) {
            $port = $portNumbers[$i] . '/' . $protocols[$i];
            $openPorts[] = $port;
        }
    }

    return $openPorts;
}
?>
